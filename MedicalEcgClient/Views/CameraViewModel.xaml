<UserControl x:Class="MedicalEcgClient.Views.CameraView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:MedicalEcgClient.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             d:DataContext="{d:DesignInstance Type=vm:CameraViewModel}">

    <UserControl.Resources>
        <Style x:Key="ToolButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#444"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Width" Value="40"/>
            <Setter Property="Height" Value="40"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
    </UserControl.Resources>

    <Grid Background="#202020">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Background="#333" >
            <Button Command="{Binding GoBackCommand}" 
                    IsEnabled="{Binding IsUploading, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}"
                    HorizontalAlignment="Left" Background="Transparent" Foreground="White" BorderThickness="0" Padding="10">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&#xE711;" FontFamily="Segoe MDL2 Assets" Margin="0,0,5,0" VerticalAlignment="Center"/>
                    <TextBlock Text="Hủy bỏ / Quay lại"/>
                </StackPanel>
            </Button>

            <StackPanel HorizontalAlignment="Center" Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Hồ sơ: " Foreground="LightGray"/>
                <TextBlock Text="{Binding CurrentPatient.FullName}" Foreground="White" FontWeight="Bold"/>
                <TextBlock Text=" (Giữ Ctrl + Cuộn chuột để Zoom)" Foreground="#AAA" FontStyle="Italic" Margin="20,0,0,0" FontSize="11"/>
            </StackPanel>
        </Grid>

        <Border Grid.Row="1" Margin="10" BorderBrush="#444" BorderThickness="1" Background="Black" ClipToBounds="True">
            <Grid>
                <Grid x:Name="ImageContainer" Background="Transparent"
                      MouseWheel="ImageContainer_MouseWheel"
                      MouseLeftButtonDown="ImageContainer_MouseLeftButtonDown"
                      MouseLeftButtonUp="ImageContainer_MouseLeftButtonUp"
                      MouseMove="ImageContainer_MouseMove">

                    <Image x:Name="DisplayImage" Source="{Binding CurrentFrame}" Stretch="Uniform" RenderTransformOrigin="0.5,0.5">
                        <Image.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform x:Name="ImgScale"/>
                                <TranslateTransform x:Name="ImgTranslate"/>
                            </TransformGroup>
                        </Image.RenderTransform>
                    </Image>
                </Grid>

                <StackPanel VerticalAlignment="Top" HorizontalAlignment="Right" Margin="20">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsStaticImageMode}" Value="True"/>
                                        <Condition Binding="{Binding IsUploading}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>

                    <Border Background="#99000000" CornerRadius="5" Padding="5">
                        <StackPanel>
                            <TextBlock Text="Chỉnh nhanh" Foreground="#AAA" HorizontalAlignment="Center" FontSize="10" Margin="0,0,0,5"/>
                            <Button Style="{StaticResource ToolButtonStyle}" Command="{Binding RotateLeftCommand}" ToolTip="Xoay trái 90 độ">
                                <TextBlock Text="&#xE7A9;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                            </Button>
                            <Button Style="{StaticResource ToolButtonStyle}" Command="{Binding RotateRightCommand}" ToolTip="Xoay phải 90 độ">
                                <TextBlock Text="&#xE7A9;" FontFamily="Segoe MDL2 Assets" FontSize="20" RenderTransformOrigin="0.5,0.5">
                                    <TextBlock.RenderTransform>
                                        <ScaleTransform ScaleX="-1"/>
                                    </TextBlock.RenderTransform>
                                </TextBlock>
                            </Button>
                            <Button Style="{StaticResource ToolButtonStyle}" Click="ResetZoom_Click" ToolTip="Reset Zoom/Pan">
                                <TextBlock Text="&#xE777;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                            </Button>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <Border VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="20"
                        Visibility="{Binding ShowAnalysisPanel, Converter={StaticResource BoolToVis}}"
                        Background="#CC000000" BorderBrush="{Binding QualityColor}" BorderThickness="0,0,0,3" CornerRadius="5" Padding="15">
                    <StackPanel Width="250">
                        <TextBlock Text="KẾT QUẢ PHÂN TÍCH" Foreground="White" FontWeight="Bold" Margin="0,0,0,10"/>
                        <Grid Margin="0,0,0,5">
                            <TextBlock Text="Độ nét:" Foreground="#CCC"/>
                            <TextBlock Text="{Binding QualityStatus}" HorizontalAlignment="Right" FontWeight="Bold" Foreground="{Binding QualityColor}"/>
                        </Grid>
                        <Grid Margin="0,0,0,5">
                            <TextBlock Text="Kích thước:" Foreground="#CCC"/>
                            <TextBlock Text="{Binding ResolutionInfo}" HorizontalAlignment="Right" Foreground="White"/>
                        </Grid>
                        <Separator Background="#555" Margin="0,5"/>
                        <TextBlock Text="Đề xuất của hệ thống:" Foreground="#FFC107" FontSize="11" Margin="0,5,0,2"/>
                        <TextBlock Text="{Binding Recommendation}" Foreground="White" TextWrapping="Wrap" FontStyle="Italic"/>
                    </StackPanel>
                </Border>

                <Grid Background="#CC000000" Visibility="{Binding IsUploading, Converter={StaticResource BoolToVis}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Width="300">
                        <TextBlock Text="&#xE896;" FontFamily="Segoe MDL2 Assets" FontSize="40" Foreground="#0D6EFD" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                        <TextBlock Text="{Binding StatusMessage}" HorizontalAlignment="Center" FontWeight="SemiBold" Foreground="White" Margin="0,0,0,5"/>
                        <ProgressBar Value="{Binding UploadProgress}" Maximum="100" Height="10" Foreground="#0D6EFD" Background="#333" BorderThickness="0"/>
                        <TextBlock Text="{Binding UploadProgress, StringFormat='{}{0:0}%'}" HorizontalAlignment="Center" Foreground="#CCC" Margin="0,5,0,0"/>
                    </StackPanel>
                </Grid>

                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding CurrentFrame}" Value="{x:Null}"/>
                                        <Condition Binding="{Binding IsCameraRunning}" Value="False"/>
                                        <Condition Binding="{Binding IsInitializing}" Value="False"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>

                    <TextBlock Text="Chọn nguồn dữ liệu:" Foreground="#AAA" HorizontalAlignment="Center" FontSize="16" Margin="0,0,0,20"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <Button Command="{Binding BrowseImageCommand}" 
                                Background="#333" Foreground="White" BorderBrush="#555" BorderThickness="1"
                                Width="180" Height="140" Margin="15" Cursor="Hand">
                            <StackPanel>
                                <TextBlock Text="&#xE8E5;" FontFamily="Segoe MDL2 Assets" FontSize="48" HorizontalAlignment="Center" Foreground="#FFC107" Margin="0,0,0,15"/>
                                <TextBlock Text="CHÈN TỪ MÁY" FontWeight="Bold" FontSize="16"/>
                                <TextBlock Text="(File ảnh có sẵn)" FontSize="12" Foreground="#AAA" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                            </StackPanel>
                        </Button>

                        <Button Command="{Binding ToggleCameraCommand}" 
                                Background="#333" Foreground="White" BorderBrush="#555" BorderThickness="1"
                                Width="180" Height="140" Margin="15" Cursor="Hand">
                            <StackPanel>
                                <TextBlock Text="&#xE722;" FontFamily="Segoe MDL2 Assets" FontSize="48" HorizontalAlignment="Center" Foreground="#0D6EFD" Margin="0,0,0,15"/>
                                <TextBlock Text="CHỤP HÌNH" FontWeight="Bold" FontSize="16"/>
                                <TextBlock Text="(Webcam / Scanner)" FontSize="12" Foreground="#AAA" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>

                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Visibility="{Binding IsInitializing, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="&#xE768;" FontFamily="Segoe MDL2 Assets" FontSize="30" HorizontalAlignment="Center" Foreground="White"/>
                    <TextBlock Text="Đang khởi động Camera..." Foreground="White"/>
                </StackPanel>

                <TextBlock Text="{Binding ErrorMessage}" Foreground="Red" FontWeight="Bold" FontSize="16"
                           VerticalAlignment="Center" HorizontalAlignment="Center" TextWrapping="Wrap" MaxWidth="300"
                           Visibility="{Binding ErrorMessage, Converter={StaticResource BoolToVis}}"/>
            </Grid>
        </Border>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,20">

            <Button Command="{Binding BrowseImageCommand}" 
                    IsEnabled="{Binding IsUploading, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}"
                    Background="#FFC107" Foreground="Black" FontWeight="Bold" FontSize="14"
                    Width="140" Height="45" Margin="10" BorderThickness="0">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&#xE8E5;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <TextBlock Text="CHÈN ẢNH"/>
                </StackPanel>
            </Button>

            <Button Command="{Binding RetakeCommand}" 
                    Background="#6C757D" Foreground="White" FontWeight="Bold" FontSize="14"
                    Width="140" Height="45" Margin="10" BorderThickness="0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding IsStaticImageMode}" Value="True"/>
                                    <Condition Binding="{Binding IsCapturedFromCamera}" Value="True"/>
                                    <Condition Binding="{Binding IsUploading}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Visible"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&#xE72C;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <TextBlock Text="CHỤP LẠI"/>
                </StackPanel>
            </Button>

            <Button Command="{Binding CaptureCommand}" 
                    Background="#0D6EFD" Foreground="White" FontWeight="Bold" FontSize="14"
                    Width="140" Height="45" Margin="10" BorderThickness="0">
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Setter Property="ToolTip" Value=""/>
                        <Setter Property="IsEnabled" Value="{Binding IsUploading, Converter={StaticResource BoolToVis}, ConverterParameter=Inverse}"/>

                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsCameraRunning}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Setter Property="ToolTip" Value="Chụp ảnh từ Camera"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsStaticImageMode}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                                <Setter Property="ToolTip" Value="Lưu và Quay về danh sách"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>

                <StackPanel Orientation="Horizontal">
                    <TextBlock FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" VerticalAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="&#xE74E;"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsCameraRunning}" Value="True">
                                        <Setter Property="Text" Value="&#xE722;"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <TextBlock>
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Text" Value="LƯU HỒ SƠ"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsCameraRunning}" Value="True">
                                        <Setter Property="Text" Value="CHỤP NGAY"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Button>

        </StackPanel>
    </Grid>
</UserControl>